name: Deploy Datasette to Vercel

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y sqlite3
      
      - name: Install Vercel CLI
        run: |
          npm install -g vercel@latest
      
      - name: Prepare database
        run: |
          cd datasette-deploy
          # Use existing database or create if missing
          if [ ! -f leaderboard.db ]; then
            echo "Creating new database..."
            sqlite3 leaderboard.db <<EOF
            CREATE TABLE IF NOT EXISTS game_scores (
              id TEXT PRIMARY KEY,
              player_name TEXT NOT NULL,
              final_net_worth INTEGER NOT NULL,
              roi REAL NOT NULL,
              successful_exits INTEGER NOT NULL,
              turns_played INTEGER NOT NULL,
              difficulty TEXT NOT NULL,
              played_at DATETIME DEFAULT CURRENT_TIMESTAMP
            );
            CREATE INDEX IF NOT EXISTS idx_net_worth ON game_scores(final_net_worth DESC);
            CREATE INDEX IF NOT EXISTS idx_roi ON game_scores(roi DESC);
            CREATE INDEX IF NOT EXISTS idx_player ON game_scores(player_name);
            CREATE INDEX IF NOT EXISTS idx_difficulty ON game_scores(difficulty);
            EOF
            echo "✓ Created new database"
          else
            echo "✓ Using existing database"
          fi
      
      - name: Verify database
        run: |
          cd datasette-deploy
          sqlite3 leaderboard.db "SELECT COUNT(*) as count FROM game_scores;" || echo "Database check completed"
          echo "✓ Database verified"
      
      - name: Deploy to Vercel
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          if [ -z "$VERCEL_TOKEN" ]; then
            echo "⚠️  VERCEL_TOKEN secret not set. Skipping deployment."
            echo "To enable deployment, add VERCEL_TOKEN to GitHub Secrets:"
            echo "1. Go to https://vercel.com/account/tokens"
            echo "2. Create a new token"
            echo "3. Add it to GitHub repo secrets as VERCEL_TOKEN"
            exit 0
          fi
          
          cd datasette-deploy
          
          # Link to project first (if not already linked)
          if [ ! -f .vercel/project.json ]; then
            echo "Linking to project unicorn-leaderboard..."
            echo "y" | vercel link --token=$VERCEL_TOKEN --project=unicorn-leaderboard || true
          fi
          
          # Deploy using Vercel CLI
          echo "Deploying to Vercel..."
          vercel deploy --prod --token=$VERCEL_TOKEN --yes
      
      - name: Deployment summary
        if: always()
        run: |
          echo "## Deployment Status" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" = "success" ]; then
            echo "✅ Datasette deployed successfully!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Visit: https://unicorn-leaderboard.vercel.app" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Note: If POSTGRES_URL is set in Vercel, it will use Postgres. Otherwise, it will use SQLite." >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Deployment failed. Check logs above." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Common issues:" >> $GITHUB_STEP_SUMMARY
            echo "- VERCEL_TOKEN not set in GitHub Secrets" >> $GITHUB_STEP_SUMMARY
            echo "- Python dependencies not installed correctly" >> $GITHUB_STEP_SUMMARY
            echo "- Database file missing or corrupted" >> $GITHUB_STEP_SUMMARY
          fi
