name: Deploy Datasette to Vercel

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - master
    paths:
      - 'datasette-deploy/**'
      - '.github/workflows/datasette-deploy.yml'
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Install Vercel CLI
        run: npm install -g vercel
      
      - name: Deploy to Vercel
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          if [ -z "$VERCEL_TOKEN" ]; then
            echo "⚠️  VERCEL_TOKEN secret not set. Skipping deployment."
            echo "To enable deployment, add these secrets to GitHub:"
            echo "1. VERCEL_TOKEN - Get from https://vercel.com/account/tokens"
            echo "2. VERCEL_ORG_ID - Get from Vercel project settings"
            echo "3. VERCEL_PROJECT_ID - Get from Vercel project settings"
            exit 0
          fi
          
          cd datasette-deploy
          
          # Pull environment (links project)
          vercel pull --yes --environment=production --token=$VERCEL_TOKEN || echo "Project link step"
          
          # Build
          vercel build --prod --token=$VERCEL_TOKEN
          
          # Deploy
          vercel deploy --prod --token=$VERCEL_TOKEN
      
      - name: Deployment summary
        if: always()
        run: |
          echo "## Deployment Status" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" = "success" ]; then
            echo "✅ Datasette deployed successfully!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The deployment connects to Postgres via POSTGRES_URL environment variable." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Note:** Ensure POSTGRES_URL is set in Vercel dashboard." >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Deployment failed. Check logs above." >> $GITHUB_STEP_SUMMARY
          fi
